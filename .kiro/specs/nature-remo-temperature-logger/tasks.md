# 実装計画: Nature Remo温度記録システム

## 概要

Nature Remo APIを使用して10分ごとに室温を記録し、GitHub Actionsで自動実行するシステムを実装します。データはCSV形式でGitHubリポジトリに保存され、長期的な温度履歴の記録と分析を可能にします。

## タスク

- [x] 1. プロジェクト構造とコア機能の実装
  - [x] 1.1 プロジェクト構造とディレクトリを作成
    - `logger.py`（メインスクリプト）
    - `data/`（データ保存ディレクトリ）
    - `tests/unit/`（ユニットテスト）
    - `tests/property/`（プロパティテスト）
    - `requirements.txt`（依存関係）
    - _要件: 全般_

  - [x] 1.2 Nature Remo API クライアント機能を実装
    - `get_temperature()`関数: APIから温度データを取得
    - HTTPSリクエストの送信
    - 認証ヘッダーの設定
    - レスポンスのパースと温度値の抽出
    - _要件: 2.1, 2.2, 2.4_

  - [ ]* 1.3 API クライアントのプロパティテストを作成
    - **プロパティ3: HTTPS通信の使用**
    - **プロパティ4: 成功レスポンスからのデータ抽出**
    - **検証要件: 2.1, 2.2**

  - [ ]* 1.4 API クライアントのユニットテストを作成
    - 成功レスポンスのテスト
    - タイムアウトエラーのテスト
    - _要件: 2.2, 2.5_

- [x] 2. エラーハンドリングとリトライ機能の実装
  - [x] 2.1 リトライロジックを実装
    - 指数バックオフを使用したリトライ機能
    - リトライ可能なエラーの判定
    - 最大3回のリトライ
    - _要件: 2.3, 5.2_

  - [x] 2.2 エラーログ機能を実装
    - エラーメッセージ、タイムスタンプ、エラータイプの記録
    - ログレベルの設定（ERROR, WARNING, INFO, DEBUG）
    - _要件: 5.1_

  - [ ]* 2.3 エラーハンドリングのプロパティテストを作成
    - **プロパティ5: エラーレスポンスのリトライ**
    - **プロパティ9: エラーログの記録**
    - **検証要件: 2.3, 5.1, 5.2**

  - [ ]* 2.4 エラーハンドリングのユニットテストを作成
    - 無効なトークンエラーのテスト
    - 全リトライ失敗時のテスト
    - _要件: 1.3, 5.3_

- [x] 3. データ検証機能の実装
  - [x] 3.1 温度値検証機能を実装
    - `validate_temperature()`関数: 数値チェックと範囲チェック
    - 範囲外の値に対する警告ログ
    - _要件: 6.1, 6.2, 6.3_

  - [x] 3.2 タイムスタンプ検証機能を実装
    - `validate_timestamp()`関数: ISO 8601形式の検証
    - タイムスタンプのフォーマット機能
    - _要件: 2.4, 9.2_

  - [x] 3.3 重複チェック機能を実装
    - 既存CSVファイルから既存タイムスタンプを読み込み
    - 重複タイムスタンプの検出と拒否
    - _要件: 6.4_

  - [ ]* 3.4 データ検証のプロパティテストを作成
    - **プロパティ6: タイムスタンプの形式**
    - **プロパティ11: 温度値の検証**
    - **プロパティ12: 重複タイムスタンプの拒否**
    - **検証要件: 2.4, 6.1, 6.2, 6.4, 9.2**

  - [ ]* 3.5 データ検証のユニットテストを作成
    - 範囲外温度の警告テスト
    - 無効なタイムスタンプ形式のテスト
    - _要件: 6.3_

- [x] 4. チェックポイント - 基本機能の確認
  - すべてのテストが成功することを確認
  - 質問があればユーザーに確認

- [x] 5. CSV ファイル操作機能の実装
  - [x] 5.1 CSV 書き込み機能を実装
    - `save_temperature()`関数: CSVファイルへのデータ保存
    - ヘッダー行の作成（ファイルが存在しない場合）
    - データ行の追記
    - 温度値の精度（小数点以下1桁）
    - _要件: 4.1, 4.2, 4.3, 4.4, 9.3_

  - [x] 5.2 安全なファイル書き込みを実装
    - 一時ファイルを使用した安全な書き込み
    - 書き込み失敗時のロールバック
    - _要件: 5.5_

  - [x] 5.3 CSV フォーマット検証を実装
    - CSV形式の正当性チェック
    - BOMなしのUTF-8エンコーディング
    - _要件: 6.5, 9.4_

  - [ ]* 5.4 CSV 操作のプロパティテストを作成
    - **プロパティ7: CSV形式での保存**
    - **プロパティ8: ファイルへのデータ追記**
    - **プロパティ15: 機械可読形式とエンコーディング**
    - **プロパティ16: 温度値の精度**
    - **検証要件: 4.1, 4.2, 4.3, 6.5, 9.1, 9.3, 9.4**

  - [ ]* 5.5 CSV 操作のユニットテストを作成
    - ヘッダー作成のテスト
    - ファイル書き込み失敗のテスト
    - _要件: 4.3, 4.4, 5.5_

- [x] 6. 設定管理とセキュリティ機能の実装
  - [x] 6.1 環境変数からの設定読み込みを実装
    - `get_api_token()`関数: 環境変数からトークン取得
    - `load_config()`関数: 設定の読み込み
    - デフォルト設定のサポート
    - _要件: 1.2, 8.3, 8.4_

  - [x] 6.2 トークンの機密性保護を実装
    - ログ出力のサニタイズ機能
    - トークンのマスキング
    - _要件: 1.4_

  - [ ]* 6.3 設定管理のプロパティテストを作成
    - **プロパティ1: 環境変数からのトークン取得**
    - **プロパティ2: トークンの機密性保護**
    - **プロパティ14: 環境変数による設定**
    - **検証要件: 1.2, 1.4, 8.3**

  - [ ]* 6.4 設定管理のユニットテストを作成
    - 環境変数からのトークン取得テスト
    - デフォルト設定のテスト
    - _要件: 1.2, 8.4_

- [x] 7. メイン処理の実装
  - [x] 7.1 メイン関数を実装
    - `main()`関数: 全体の処理フロー
    - APIトークンの取得
    - 温度データの取得
    - データの検証
    - CSVへの保存
    - エラーハンドリング
    - _要件: 全般_

  - [ ]* 7.2 統合テストを作成
    - エンドツーエンドの動作確認
    - モックAPIを使用したテスト
    - _要件: 全般_

- [x] 8. チェックポイント - コア機能の完成確認
  - すべてのテストが成功することを確認
  - 質問があればユーザーに確認

- [x] 9. GitHub Actions ワークフローの実装
  - [x] 9.1 ワークフロー定義ファイルを作成
    - `.github/workflows/temperature-logger.yml`
    - cronスケジュール設定（10分ごと）
    - 手動トリガー（workflow_dispatch）のサポート
    - _要件: 3.1, 3.4_

  - [x] 9.2 Python 実行環境の設定
    - Python 3.11のセットアップ
    - 依存関係のインストール
    - _要件: 全般_

  - [x] 9.3 Git 設定とコミット処理を実装
    - Gitユーザー設定
    - データファイルのコミット
    - リポジトリへのプッシュ
    - _要件: 4.5_

  - [x] 9.4 GitHub Secrets の設定手順をドキュメント化
    - README.mdに設定手順を記載
    - `NATURE_REMO_TOKEN`の設定方法
    - _要件: 1.1_

- [ ] 10. オプション機能の実装（JSON形式サポート）
  - [ ] 10.1 JSON 形式での保存機能を実装
    - `save_temperature_json()`関数
    - JSON形式でのデータ保存
    - _要件: 8.2, 9.1_

  - [ ]* 10.2 JSON 形式のプロパティテストを作成
    - **プロパティ13: JSON形式のサポート**
    - **検証要件: 8.2**

- [x] 11. ドキュメントの作成
  - [x] 11.1 README.md を作成
    - システムの概要
    - セットアップ手順
    - GitHub Secretsの設定方法
    - 使用方法
    - トラブルシューティング
    - _要件: 全般_

  - [x] 11.2 requirements.txt を作成
    - 必要なPythonパッケージのリスト
    - `requests`（HTTP クライアント）
    - `pytest`（テストフレームワーク）
    - `hypothesis`（プロパティテスト）
    - _要件: 全般_

- [x] 12. 最終チェックポイント
  - すべてのテストが成功することを確認
  - ワークフローが正しく動作することを確認
  - ドキュメントが完全であることを確認
  - 質問があればユーザーに確認

## 注意事項

- `*`マークの付いたタスクはオプションで、より速いMVP開発のためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、問題を早期に発見します
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例やエッジケースを検証します
